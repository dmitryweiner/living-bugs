# World Config — Правила конфигурации мира

Этот документ описывает все параметры `WorldConfig`, управляющие поведением симуляции.
Конфиг хранится в `configs/world-config.json` и загружается движком при старте.

---

## 1. Мир (`world`)

| Параметр   | Тип     | Дефолт | Описание                                      |
|------------|---------|--------|-----------------------------------------------|
| `width`    | number  | 2000   | Ширина мира в условных единицах               |
| `height`   | number  | 2000   | Высота мира в условных единицах               |
| `boundary` | string  | "torus"| Тип границ: `"torus"` (wrap-around)           |

### Тор (wrap-around)

Если существо выходит за правый край (`x > width`), его координата становится `x - width`.
Аналогично для всех четырёх сторон. Сенсоры (лучи зрения) также учитывают wrap-around:
луч, пересекающий границу, продолжается с противоположной стороны.

---

## 2. Симуляция (`simulation`)

| Параметр       | Тип    | Дефолт | Описание                                          |
|----------------|--------|--------|---------------------------------------------------|
| `tickRate`     | number | 30     | Количество sim-тиков в секунду                    |
| `brainRate`    | number | 10     | Частота вычисления мозга (Гц). Мозг считается реже, чем физика |
| `maxCreatures` | number | 5000   | Максимальное количество существ. При превышении размножение блокируется |
| `initialCreatures` | number | 200 | Количество существ при старте мира               |
| `seed`         | number | 42     | Seed для PRNG. Одинаковый seed = одинаковая симуляция |

---

## 3. Энергия (`energy`)

Энергия — единственная "валюта" в мире. Существо умирает, когда энергия <= 0.

| Параметр            | Тип    | Дефолт | Описание                                         |
|---------------------|--------|--------|--------------------------------------------------|
| `initialEnergy`     | number | 100    | Начальная энергия нового существа                |
| `maxEnergy`         | number | 500    | Максимум энергии (больше не набирается)          |
| `baseMetabolism`    | number | 0.1    | Базовый расход энергии за тик (просто за жизнь)  |
| `moveCost`          | number | 0.05   | Расход энергии за единицу скорости за тик        |
| `turnCost`          | number | 0.02   | Расход энергии за поворот за тик                 |
| `attackCost`        | number | 2.0    | Расход энергии за одну атаку                     |
| `visionCostPerRay`  | number | 0.01   | Расход за каждый луч зрения за тик               |
| `broadcastCost`     | number | 0.05   | Расход за отправку broadcast-сигнала за тик      |

### Формула расхода за тик

```
cost = baseMetabolism
     + moveCost * |velocity|
     + turnCost * |angularVelocity|
     + visionCostPerRay * numberOfRays
     + broadcastCost * (isBroadcasting ? 1 : 0)
```

Существо с большим количеством сенсоров платит больше, что создаёт эволюционное давление
на минимизацию органов чувств при сохранении функциональности.

---

## 4. Еда (`food`)

Еда — объекты на карте, дающие энергию при контакте.

| Параметр         | Тип    | Дефолт | Описание                                         |
|------------------|--------|--------|--------------------------------------------------|
| `spawnRate`      | number | 5      | Количество единиц еды, спавнящихся за тик        |
| `nutritionValue` | number | 20     | Количество энергии, получаемой при поедании       |
| `maxCount`       | number | 500    | Максимум единиц еды на карте (спавн останавливается) |
| `radius`         | number | 3      | Радиус объекта еды (для коллизий)                |

### Механика

- Каждый тик спавнится `spawnRate` единиц еды в случайных точках (PRNG).
- Спавн останавливается, если количество еды на карте >= `maxCount`.
- При контакте существа с едой: существо получает `nutritionValue` энергии (capped at `maxEnergy`), еда удаляется.
- Если у существа есть актуатор `eat`, поедание происходит только при активации актуатора.
  Если актуатора `eat` нет, существо не может есть вообще.

---

## 5. Бой (`combat`)

| Параметр       | Тип    | Дефолт | Описание                                         |
|----------------|--------|--------|--------------------------------------------------|
| `baseDamage`   | number | 15     | Базовый урон атаки                               |
| `attackRadius` | number | 10     | Радиус зоны атаки (от центра существа)           |
| `attackCooldown` | number | 5    | Минимальное количество тиков между атаками       |

### Механика

- Существо активирует актуатор `attack`.
- Все существа в радиусе `attackRadius` от атакующего получают `baseDamage` урона (теряют энергию).
- Атакующее существо тратит `energy.attackCost` энергии.
- После атаки наступает cooldown: `attackCooldown` тиков, в течение которых атака невозможна.
- IFF: если у атакующего `hasIFF = true`, существа с тем же `groupId` НЕ получают урон.
  Если `hasIFF = false`, урон наносится всем в радиусе, включая "своих".

---

## 6. Размножение (`reproduction`)

| Параметр              | Тип    | Дефолт | Описание                                     |
|-----------------------|--------|--------|----------------------------------------------|
| `energyThreshold`     | number | 200    | Минимальная энергия для деления              |
| `offspringEnergyShare`| number | 0.4    | Доля энергии родителя, передаваемая потомку  |
| `mutationRate`        | number | 0.1    | Вероятность мутации каждого гена при делении |
| `mutationStrength`    | number | 0.2    | Сила мутации (стандартное отклонение для jitter числовых параметров) |
| `cooldown`            | number | 30     | Тиков после деления, в течение которых нельзя делиться снова |

### Механика

- Когда `creature.energy >= energyThreshold`, существо делится автоматически.
- Потомок создаётся рядом с родителем (случайное направление, расстояние = 2 * radius).
- Энергия родителя уменьшается на `offspringEnergyShare * energy`.
- Потомок получает `offspringEnergyShare * parentEnergy` энергии.
- ДНК потомка = ДНК родителя + мутации (см. документ "Формат ДНК").
- После деления у родителя начинается cooldown.

---

## 7. Смерть (`death`)

| Параметр        | Тип    | Дефолт | Описание                                      |
|-----------------|--------|--------|-----------------------------------------------|
| `foodDropRatio` | number | 0.5    | Доля энергии существа, конвертируемая в еду   |
| `foodDropMax`   | number | 5      | Максимум единиц еды из одного тела            |

### Механика

- Когда `creature.energy <= 0`, существо умирает.
- На месте смерти появляется еда: `min(foodDropMax, floor(lastEnergy * foodDropRatio / food.nutritionValue))` единиц.
- `lastEnergy` — энергия существа на предыдущем тике (до обнуления).
- Еда от тела появляется в случайных точках рядом с местом смерти (радиус = 2 * creatureRadius).

---

## 8. Донат (`donation`)

| Параметр        | Тип    | Дефолт | Описание                                      |
|-----------------|--------|--------|-----------------------------------------------|
| `donateRadius`  | number | 15     | Радиус передачи ресурсов                      |
| `donateAmount`  | number | 10     | Количество энергии за один акт доната         |
| `donateCost`    | number | 1.0    | Дополнительная стоимость (потери при передаче) |

### Механика

- Существо активирует актуатор `donate`.
- Ближайшее существо с тем же `groupId` в радиусе `donateRadius` получает `donateAmount` энергии.
- Донор теряет `donateAmount + donateCost` энергии.
- Если `hasIFF = false`, донат невозможен (существо не различает "своих").
- Если в радиусе нет "своих", энергия всё равно тратится (`donateCost`), но передачи не происходит.

---

## 9. Broadcast (`broadcast`)

| Параметр          | Тип    | Дефолт | Описание                                    |
|-------------------|--------|--------|---------------------------------------------|
| `broadcastRadius` | number | 100    | Радиус распространения сигнала              |
| `signalChannels`  | number | 4      | Количество каналов сигнала (0..N-1)         |

### Механика

- Существо активирует актуатор `broadcast` с выбранным каналом (0..`signalChannels`-1).
- Все существа с сенсором `broadcastReceiver` в радиусе `broadcastRadius` получают сигнал.
- Сигнал содержит: канал (число), расстояние до источника, направление на источник.
- Сигнал не фильтруется по `groupId` — любой может "услышать".
  Отличить "своих" от "чужих" — задача мозга существа (если есть IFF-сенсор на источнике).

---

## 10. Creature defaults (`creatureDefaults`)

Параметры по умолчанию для тел существ.

| Параметр     | Тип    | Дефолт | Описание                                       |
|--------------|--------|--------|-------------------------------------------------|
| `radius`     | number | 5      | Радиус тела существа (для коллизий и рендера)  |
| `maxSpeed`   | number | 2.0    | Максимальная скорость движения за тик           |
| `maxTurnRate`| number | 0.15   | Максимальная скорость поворота (рад/тик)        |

---

## Полный пример конфига

```json
{
  "world": {
    "width": 2000,
    "height": 2000,
    "boundary": "torus"
  },
  "simulation": {
    "tickRate": 30,
    "brainRate": 10,
    "maxCreatures": 5000,
    "initialCreatures": 200,
    "seed": 42
  },
  "energy": {
    "initialEnergy": 100,
    "maxEnergy": 500,
    "baseMetabolism": 0.1,
    "moveCost": 0.05,
    "turnCost": 0.02,
    "attackCost": 2.0,
    "visionCostPerRay": 0.01,
    "broadcastCost": 0.05
  },
  "food": {
    "spawnRate": 5,
    "nutritionValue": 20,
    "maxCount": 500,
    "radius": 3
  },
  "combat": {
    "baseDamage": 15,
    "attackRadius": 10,
    "attackCooldown": 5
  },
  "reproduction": {
    "energyThreshold": 200,
    "offspringEnergyShare": 0.4,
    "mutationRate": 0.1,
    "mutationStrength": 0.2,
    "cooldown": 30
  },
  "death": {
    "foodDropRatio": 0.5,
    "foodDropMax": 5
  },
  "donation": {
    "donateRadius": 15,
    "donateAmount": 10,
    "donateCost": 1.0
  },
  "broadcast": {
    "broadcastRadius": 100,
    "signalChannels": 4
  },
  "creatureDefaults": {
    "radius": 5,
    "maxSpeed": 2.0,
    "maxTurnRate": 0.15
  }
}
```
