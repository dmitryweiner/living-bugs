# Потенциальные направления развития проекта

## Текущее состояние

Проект прошёл три фазы разработки:

- **Фаза 1** — каркас монорепозитория, кинематическая физика, ДНК с сенсорами/актуаторами, NEAT-совместимый мозг с пластичностью Хебба, браузерная песочница (Pixi.js), headless CLI
- **Фаза 2** — DSL-выражения в конфиге (`expr.ts`), NEAT-специация с фитнес-шерингом, поколенческий тренинг с Hall of Fame, пакетный рендеринг (до 100k спрайтов), редактор конфига, аналитика, миникарта, браузер генотипов
- **Фаза 3** — NEAT-кроссовер (половое размножение), зрелый тренировочный пайплайн с seed-бутстрапом, визуализация графа мозга, видо-окрашенный рендеринг, сохранение Hebbian-весов в снапшотах

На текущий момент: 279 тестов, 11 модулей sim-core, полноценная браузерная песочница и CLI-тренер с поколенческим режимом.

---

## 1. Развитие симуляционного движка

### 1.1 Физика столкновений между существами [Ближайшее]

**Проблема:** сейчас существа свободно проходят сквозь друг друга — физика push-out реализована только для пары существо-препятствие (`world.ts`, функция обработки столкновений с obstacles).

**Направление:**
- Добавить попарный push-out между существами через spatial hash (`creatureHash.queryRadius`)
- Варианты: мягкая раздвижка (spring-like) или жёсткая проекция (как сейчас для препятствий)
- Это откроет тактические возможности: блокирование пути, стадное поведение, оборонительные формации

**Сложность:** низкая — механика уже реализована для obstacle, нужно обобщить на пары creature-creature.

### 1.2 Динамическая среда [Среднесрочное]

**Текущее состояние:** мир статичен — постоянная скорость спавна еды, фиксированные препятствия, однородные условия.

**Направления:**
- **Цикл день/ночь** — модулятор видимости (maxDistance сенсоров) и скорости спавна еды; DSL-выражения (`expr.ts`) уже поддерживают переменные, достаточно добавить `world.time` или `world.dayPhase` в контекст
- **Сезоны** — медленные циклы изменения `food.spawnRate` и `food.nutritionValue`; создают эволюционное давление на запасание энергии
- **Зоны ресурсов** — неравномерное распределение еды по карте (горячие точки); стимулирует миграцию и территориальное поведение
- **Деградация среды** — области, где еда истощается при интенсивном потреблении и восстанавливается со временем

**Сложность:** средняя — требуется расширение `ExprContext` и, для зон, пространственная карта ресурсов.

### 1.3 Пищевая цепочка [Среднесрочное]

**Текущее состояние:** два трофических уровня — растительная еда и существа, которые могут есть еду и атаковать друг друга.

**Направления:**
- Добавить **растения** как живые сущности (растут, размножаются делением, потребляют "солнечный свет")
- **Травоядные/хищники** — разделить eat на eat-food и eat-creature; хищник получает энергию от убитой жертвы, а не только из food-дропов при смерти
- **Паразитизм** — drain-актуатор, высасывающий энергию без убийства
- **Мусорщики** — существа, специализирующиеся на food-дропах от трупов

**Сложность:** высокая — требует нового типа сущностей, новых актуаторов, балансировки энергетической экономики.

### 1.4 Химическая сигнализация (феромоны) [Долгосрочное]

**Текущее состояние:** broadcast-система (`broadcastReceiver` сенсор, `broadcast` актуатор) работает мгновенно и не оставляет следов.

**Направления:**
- **Феромонные следы** — существа оставляют метки, которые рассеиваются со временем; новый grid-слой с диффузией
- **Хемотаксис** — сенсор, считывающий градиент феромона (направление к источнику)
- Позволит эволюции изобрести: маршруты к еде (как у муравьёв), территориальные метки, тревожные сигналы

**Сложность:** высокая — требуется отдельная grid-система диффузии, новые сенсоры, значительная нагрузка на производительность.

### 1.5 Эволюция морфологии [Долгосрочное]

**Текущее состояние:** тело существа — круг с одним параметром `radius` (3–10) в `BodyGene`.

**Направления:**
- **Составные тела** — несколько сегментов (голова + туловище), каждый со своим радиусом и позицией сенсоров
- **Асимметрия** — размещение сенсоров не по центру масс (глаза спереди vs. по бокам)
- **Специализация поверхности** — участки тела для атаки, защиты, захвата еды

**Сложность:** очень высокая — требует переработки физики, рендеринга и ДНК-формата.

---

## 2. Нейросеть и мозг

### 2.1 Ламаркианское наследование [Ближайшее]

**Текущее состояние:** Hebbian-пластичность (`brain.ts`, `hebbianUpdate`) модифицирует веса в течение жизни, но при размножении потомок получает только геномные веса из ДНК.

**Направление:** опциональный режим, при котором `runtimeWeights` (адаптированные Hebbian-весами) передаются потомку целиком или частично (с шумом). Это ускорит обучение полезным поведениям — эффект Болдуина.

**Реализация:** в `world.ts` при `reproduce()` вызывать `exportWeights(parentRuntime)` и `importWeights(childRuntime, parentWeights)` — функции уже экспортированы из `brain.ts`.

**Сложность:** низкая — инфраструктура полностью готова.

### 2.2 Пакетное вычисление мозгов [Ближайшее]

**Текущее состояние:** каждый мозг вычисляется индивидуально (`brainForwardPass` в `brain.ts`) с Float32Array на существо.

**Направление:** группировать существ с одинаковой топологией (одинаковые nodeGenes/connectionGenes) и выполнять матричный forward pass одним вызовом. Для популяции с 4 архетипами большинство мозгов будут похожи по структуре.

**Сложность:** средняя — требуется кластеризация по топологии и батчированная арифметика.

### 2.3 Рабочая память [Среднесрочное]

**Текущее состояние:** рекуррентные связи реализованы через `prevActivations` в `BrainRuntime`, что даёт простейшую память на один тик.

**Направления:**
- **LSTM-подобные ячейки** — новый тип узла `memory` с gate-механизмом (forget, input, output gates); позволит запоминать информацию на десятки тиков
- **Внешний регистр** — фиксированное число ячеек памяти, доступных как вход и выход мозга; эволюция решает, что запоминать
- **Стек** — push/pop операции для более сложных поведенческих программ

**Сложность:** средняя–высокая — новые типы узлов в NEAT, расширение мутаций.

### 2.4 Модульные подсети [Среднесрочное]

**Текущее состояние:** один монолитный граф от сенсоров к актуаторам.

**Направление:** мозг как композиция модулей — например, "модуль навигации" (rayVision → move), "модуль боя" (touch + IFF → attack), "модуль социальности" (broadcast → donate). Модули могут кроссоверировать независимо, ускоряя эволюцию сложного поведения.

**Сложность:** высокая — требует иерархической организации NEAT-генома.

### 2.5 Расширенная нейромодуляция [Долгосрочное]

**Текущее состояние:** Hebbian-правило `dw = plasticityRate * pre * post * modulator`, где `modulator = clamp(energyDelta/10, -1, 1)`.

**Направления:**
- **Множественные модуляторы** — отдельные "гормоны" (энергия, боль, социальный контакт), каждый влияет на свой набор связей
- **Эволюция правил обучения** — вместо фиксированного Hebbian-правила, коэффициенты правила (A*pre*post + B*pre + C*post + D) эволюционируют в ДНК
- **Гомеостатическая пластичность** — автоматическая нормализация активаций, предотвращающая насыщение сети

**Сложность:** высокая — расширение `BrainGenome`, новые поля в ДНК, настройка баланса.

---

## 3. Эволюция и тренировочный пайплайн

### 3.1 Многокритериальная оптимизация [Среднесрочное]

**Текущее состояние:** фитнес — скаляр `age * (energy / maxEnergy)` в `run.ts`.

**Направления:**
- **NSGA-II** — Pareto-фронт по нескольким критериям: выживаемость, число потомков, энергоэффективность, разнообразие поведения
- **Lexicographic selection** — приоритизация критериев (сначала выживание, при равенстве — энергоэффективность)
- Позволит получить специализированные виды: долгожители, плодовитые, экономичные

**Сложность:** средняя — NSGA-II хорошо документирован, нужна интеграция с `speciation.ts`.

### 3.2 Островная модель [Среднесрочное]

**Текущее состояние:** одна популяция в одном мире.

**Направление:** параллельный запуск N миров ("островов") с периодической миграцией лучших генотипов между ними. Это усиливает разнообразие и предотвращает преждевременную конвергенцию.

**Реализация:** headless-раннер запускает несколько экземпляров `World`, каждые M поколений обменивает top-K генотипов. Можно распараллелить через Worker threads в Node.js.

**Сложность:** средняя — sim-core чистый и stateless-friendly, но нужна инфраструктура для обмена.

### 3.3 Novelty Search [Среднесрочное]

**Текущее состояние:** отбор исключительно по фитнесу.

**Направление:** дополнить или заменить фитнес-отбор поиском новизны (Novelty Search, Lehman & Stanley 2011). Поведение кодируется вектором (средняя скорость, число атак, пройденное расстояние, число детей), и отбираются генотипы, чьё поведение наиболее непохоже на архив. Это позволяет преодолевать ловушки локальных оптимумов.

**Сложность:** средняя — нужен behavioral descriptor и архив, но не затрагивает core simulation.

### 3.4 Коэволюция хищников и жертв [Среднесрочное]

**Текущее состояние:** 4 архетипа (solo hunter, social cooperator, solo forager, social predator) эволюционируют в общей популяции.

**Направление:** явное разделение на хищников и жертв с раздельным фитнесом — хищник награждается за убийства, жертва за выживание. Гонка вооружений (arms race) приводит к возникновению всё более сложных стратегий с обеих сторон.

**Сложность:** средняя — требует раздельного фитнеса по groupId и, возможно, раздельной специации.

### 3.5 Curriculum Learning [Долгосрочное]

**Направление:** начинать тренировку в простой среде (много еды, нет хищников) и постепенно усложнять условия (меньше еды, больше конкуренции, препятствия). Это помогает эволюции пройти промежуточные ступени, которые невозможны при сразу сложной среде.

**Реализация:** скрипт-оркестратор, который модифицирует `world-config.json` между фазами тренировки.

**Сложность:** низкая технически, но требует экспериментов с расписанием.

### 3.6 Половой отбор [Долгосрочное]

**Текущее состояние:** при `crossoverRate > 0` партнёр выбирается из ближайших существ той же группы с достаточной энергией (`world.ts`, `reproduce()`).

**Направление:** добавить механизм выбора партнёра — существо-самка "оценивает" кандидатов (по размеру, энергии, broadcast-сигналу) через отдельный выход мозга. Это создаёт давление на развитие "привлекательных" признаков (сигналов честности).

**Сложность:** средняя — новый актуатор `mate-choice` + логика в `reproduce()`.

---

## 4. Визуализация и пользовательский опыт

### 4.1 Система записи и воспроизведения [Ближайшее]

**Текущее состояние:** можно сохранить/загрузить снапшот мира (IndexedDB), но нет возможности записать историю и "перемотать" назад.

**Направления:**
- **Запись тиков** — сохранение ключевых событий (`SimEvent[]`) каждые N тиков; компактный формат (delta-encoding позиций)
- **Воспроизведение** — slider для перемотки; визуализация "призрачных" позиций из прошлого
- **Экспорт в видео** — рендеринг записи в MP4 через OffscreenCanvas + MediaRecorder API

**Сложность:** средняя — `SimEvent` уже определён в `types.ts`, нужна инфраструктура хранения и проигрывания.

### 4.2 Филогенетическое дерево [Среднесрочное]

**Текущее состояние:** Hall of Fame хранит лучшие генотипы, но без связи "потомок-родитель".

**Направления:**
- При рождении сохранять `parentId` (и `mateId` при кроссовере) в `CreatureState`
- Визуализация дерева потомков (D3.js или Canvas) — ветвление, вымирание линий, появление новых видов
- Окраска по видовой принадлежности (speciation)

**Сложность:** средняя — нужно расширение `CreatureState` и новый UI-компонент.

### 4.3 Визуализация мозга в инспекторе [Ближайшее]

**Текущее состояние:** визуализация графа мозга доступна только в браузере генотипов (`brain-graph.ts`), но не для живого существа.

**Направление:** при выборе существа показывать его мозг в реальном времени — активации узлов подсвечиваются яркостью, толщина связей отражает текущие Hebbian-веса (а не только геномные).

**Реализация:** использовать существующий `brain-graph.ts`, передавая `runtime.activations` для подсветки и `exportWeights(runtime)` для текущих весов.

**Сложность:** низкая — компонент уже есть, нужна интеграция с inspector.

### 4.4 Расширенная аналитика [Среднесрочное]

**Текущее состояние:** `analytics.ts` отображает 3 линии (creatures, food, avg energy) в Canvas 2D.

**Направления:**
- **Stacked area chart** видов (по groupId) — уже есть зачатки в species tab
- **Scatter plot фитнеса** — распределение фитнеса по популяции в реальном времени
- **Тепловая карта** — плотность существ и еды на карте мира
- **Генетическая дистанция** — средняя NEAT-совместимость в популяции как мера разнообразия
- **Экспорт CSV/JSON** — данные временных рядов для внешнего анализа

**Сложность:** средняя — по компоненту на график, данные уже собираются в `TickMetrics`.

### 4.5 Звуковое оформление [Долгосрочное]

**Направление:** Web Audio API для амбиентного звука: фоновый шум пропорционален популяции, акценты на события (атака, размножение, смерть рядом с камерой).

**Сложность:** низкая технически, но требует подбора/создания звуков.

---

## 5. Производительность и масштабируемость

### 5.1 WebAssembly [Среднесрочное]

**Текущее состояние:** sim-core — чистый TypeScript; forward pass мозга и spatial hash — главные узкие места.

**Направление:** перенести горячие пути (brain forward pass, spatial hash queries, geometry) в Rust/C++ → WebAssembly. Ожидаемое ускорение 3–5x для числовых операций.

**Варианты:**
- **AssemblyScript** — минимальные изменения, TS-подобный синтаксис
- **Rust + wasm-bindgen** — максимальная производительность, требует отдельного build-шага

**Сложность:** высокая — отдельная toolchain, FFI-границы, отладка.

### 5.2 Web Workers для мозгов [Ближайшее]

**Текущее состояние:** вся симуляция выполняется в main thread (браузер) или в одном потоке (Node.js).

**Направление:** вынести `brainForwardPass` в пул Web Workers (браузер) или Worker threads (Node.js). Мозги — чистые функции от входов к выходам, легко параллелятся.

**Реализация:** разбить массив существ на чанки, отправить в workers, собрать результаты. SharedArrayBuffer позволит избежать копирования.

**Сложность:** средняя — нужна сериализация brain inputs/outputs и синхронизация.

### 5.3 WebGPU compute shaders [Долгосрочное]

**Направление:** для популяций 10k+ использовать GPU для массового параллельного forward pass. Каждое существо — один invocation в compute shader; веса и активации в storage buffers.

**Сложность:** очень высокая — WebGPU API ещё не повсеместно поддерживается, сложность отладки шейдеров.

### 5.4 Оптимизация spatial hash [Ближайшее]

**Текущее состояние:** `SpatialHash` в `spatial-hash.ts` перестраивается каждый тик.

**Направления:**
- **Инкрементальное обновление** — двигать сущности между ячейками без полной перестройки
- **Иерархический grid** — грубый grid для raycast, мелкий для contact queries
- **Quad-tree** как альтернатива для неравномерных распределений

**Сложность:** низкая–средняя.

---

## 6. Платформа и архитектура

### 6.1 Мультиплеер / общие миры [Долгосрочное]

**Направление:** WebSocket-сервер, раздающий состояние мира нескольким браузерным клиентам. Каждый игрок может размещать своих существ, наблюдать за эволюцией в реальном времени.

**Варианты:**
- **Наблюдатель** — один headless-сервер симулирует, браузеры только рендерят
- **Совместное управление** — каждый игрок управляет своей группой (groupId)
- **Соревнование** — чьи генотипы доминируют через N поколений

**Сложность:** очень высокая — требуется серверная инфраструктура, синхронизация состояния, обработка задержек.

### 6.2 Система плагинов [Среднесрочное]

**Текущее состояние:** новые сенсоры и актуаторы требуют правок в `world.ts` (gatherSensorInputs, applyBrainOutputs), `dna.ts`, `types.ts`.

**Направление:** реестр сенсоров и актуаторов, позволяющий регистрировать новые типы без модификации core:
```
registry.registerSensor('pheromone', {
  outputCount: 2,
  gather: (creature, world) => [strength, direction]
});
```

**Сложность:** средняя — требуется рефакторинг sensor/actuator dispatch в `world.ts`.

### 6.3 API для внешнего управления [Среднесрочное]

**Направление:** REST или WebSocket API для программного управления симуляцией — старт/стоп/шаг, инъекция генотипов, чтение метрик. Позволит интеграцию с Jupyter, внешними ML-фреймворками, CI/CD для автоматического тренинга.

**Сложность:** средняя — нужен HTTP/WS сервер в headless app.

### 6.4 3D-визуализация [Долгосрочное]

**Направление:** альтернативный рендерер на Three.js — вид сверху (как сейчас) или свободная камера; существа как 3D-модели; ландшафт с высотами. Чисто косметическое улучшение, не влияет на симуляцию.

**Сложность:** высокая — отдельное приложение или режим рендеринга.

---

## 7. Образовательная и исследовательская ценность

### 7.1 Режим обучения [Среднесрочное]

**Направление:** пошаговый туториал, объясняющий ключевые концепции:
- Что такое нейросеть и как она управляет существом
- Как работает мутация и естественный отбор
- Зачем нужна специация и кроссовер
- Как читать граф мозга и интерпретировать поведение

**Реализация:** overlay-подсказки с примерами; preset-сценарии с комментариями.

**Сложность:** средняя — в основном UI/UX работа.

### 7.2 Preset-сценарии [Ближайшее]

**Направление:** набор преднастроенных конфигураций мира, демонстрирующих разные эволюционные феномены:
- **Гонка вооружений** — хищники vs. жертвы с выраженной борьбой
- **Дилемма кооперации** — donate выгодно для группы, но затратно для индивида
- **Ресурсный голод** — мало еды, сильная конкуренция
- **Пацифизм** — атака запрещена, выживание через эффективное собирательство
- **Радиация** — высокий `mutationRate`, быстрая эволюция

**Реализация:** JSON-файлы в `configs/presets/`, кнопка выбора в UI.

**Сложность:** низкая — всё реализуемо через `world-config.json` без изменения кода.

### 7.3 Экспорт данных для анализа [Среднесрочное]

**Направление:**
- **CSV-экспорт** метрик по тикам (популяция, средний фитнес, число видов, распределение энергии)
- **JSON-экспорт** всех генотипов с полным деревом предков
- **Интеграция с Jupyter** — Python-клиент, читающий данные из API (см. 6.3) или из экспортированных файлов

**Сложность:** низкая–средняя.

---

## 8. Технический долг и качество

### 8.1 Тесты для веб-приложения [Ближайшее]

**Проблема:** `apps/web/` не имеет ни одного тест-файла. Все 279 тестов покрывают sim-core и headless.

**Направление:**
- Unit-тесты для `config-editor.ts`, `analytics.ts`, `genotype-browser.ts` (логика фильтрации, форматирования)
- Интеграционные тесты рендеринга с mock-Pixi (проверка режимов rich/fast)
- E2E тесты (Playwright) для ключевых сценариев: загрузка, save/load, import genotypes

**Сложность:** средняя.

### 8.2 Консистентность ID в снапшотах [Ближайшее]

**Проблема:** `loadSnapshot` в `world.ts` создаёт еду через `spawnFood`, который назначает новые ID — оригинальные ID из снапшота теряются.

**Направление:** при загрузке снапшота создавать сущности напрямую, без прохождения через spawn-логику; восстанавливать оригинальные ID и состояние id-counter.

**Сложность:** низкая.

### 8.3 Перекрытие еды и препятствий [Ближайшее]

**Проблема:** еда может спавниться внутри препятствий — нет проверки при генерации.

**Направление:** при вызове `spawnFood` проверять коллизию с `obstacleHash`; если точка внутри препятствия — выбирать другую позицию.

**Сложность:** низкая — spatial hash уже используется.

### 8.4 Горячая перезагрузка конфига [Среднесрочное]

**Текущее состояние:** конфиг загружается один раз; редактор в браузере модифицирует `world.config` напрямую, но headless не поддерживает runtime-изменения.

**Направление:**
- Файловый watcher в headless для `world-config.json`
- Валидация нового конфига перед применением
- Событие `configChanged` для реакции в UI

**Сложность:** низкая–средняя.

### 8.5 Миграция на ECS-архитектуру [Долгосрочное]

**Текущее состояние:** сущности — объекты в `Map<number, CreatureInternal>` с полным набором полей.

**Направление:** Entity-Component-System (ECS) с column-oriented хранилищем (SoA) для лучшей cache-locality и масштабируемости. Компоненты: Position, Velocity, Energy, Brain, DNA, Sensors. Системы: MovementSystem, BrainSystem, CollisionSystem, ReproductionSystem.

**Сложность:** очень высокая — фундаментальный рефакторинг всего sim-core.

---

## Приоритизация

### Ближайшие задачи (низкий риск, высокая отдача)

| # | Задача | Секция | Сложность |
|---|--------|--------|-----------|
| 1 | Ламаркианское наследование | 2.1 | Низкая |
| 2 | Визуализация мозга в инспекторе | 4.3 | Низкая |
| 3 | Preset-сценарии | 7.2 | Низкая |
| 4 | Фикс перекрытия еды/препятствий | 8.3 | Низкая |
| 5 | Фикс ID в снапшотах | 8.2 | Низкая |
| 6 | Физика creature-creature | 1.1 | Низкая |
| 7 | Оптимизация spatial hash | 5.4 | Низкая–средняя |
| 8 | Система записи/воспроизведения | 4.1 | Средняя |

### Среднесрочные (расширение функциональности)

| # | Задача | Секция | Сложность |
|---|--------|--------|-----------|
| 9 | Динамическая среда | 1.2 | Средняя |
| 10 | Многокритериальная оптимизация | 3.1 | Средняя |
| 11 | Островная модель | 3.2 | Средняя |
| 12 | Novelty Search | 3.3 | Средняя |
| 13 | Расширенная аналитика | 4.4 | Средняя |
| 14 | Система плагинов | 6.2 | Средняя |
| 15 | Экспорт данных | 7.3 | Низкая–средняя |
| 16 | Тесты web app | 8.1 | Средняя |

### Долгосрочные (амбициозные цели)

| # | Задача | Секция | Сложность |
|---|--------|--------|-----------|
| 17 | Пищевая цепочка | 1.3 | Высокая |
| 18 | Химическая сигнализация | 1.4 | Высокая |
| 19 | Эволюция морфологии | 1.5 | Очень высокая |
| 20 | WebAssembly | 5.1 | Высокая |
| 21 | WebGPU | 5.3 | Очень высокая |
| 22 | Мультиплеер | 6.1 | Очень высокая |
| 23 | ECS-архитектура | 8.5 | Очень высокая |
