# Формат ДНК — Описание генома существ

ДНК определяет строение тела существа: какие сенсоры (органы чувств) и актуаторы (исполнительные органы) 
у него есть, а также параметры каждого модуля. ДНК не описывает мозг — для этого есть отдельный документ.

---

## 1. Общая структура генома

```typescript
interface DNA {
  // Идентификация
  groupId: number;        // ID группы (наследуется, не мутирует)
  hasIFF: boolean;        // Распознавание свой/чужой (может мутировать)

  // Тело
  body: BodyGene;

  // Модули
  sensors: SensorGene[];     // Массив сенсоров
  actuators: ActuatorGene[]; // Массив актуаторов

  // Мозг (ссылка на NEAT-геном, описан в отдельном документе)
  brain: BrainGenome;
}
```

---

## 2. Тело (`BodyGene`)

```typescript
interface BodyGene {
  radius: number;    // 3..10, дефолт 5. Радиус существа.
  // Больше тело = больше HP-like запас, но дороже метаболизм
  // basemetabolism *= (radius / defaultRadius)^2
}
```

### Мутация тела
- `radius`: jitter ±`mutationStrength`, clamp [3, 10]

---

## 3. Сенсоры (`SensorGene`)

Каждый сенсор — отдельный ген в массиве `sensors`. Порядок сенсоров определяет порядок
входов в нейросеть.

### 3.1 Ray Vision (`rayVision`)

Набор лучей, исходящих из тела существа. Каждый луч возвращает:
- расстояние до ближайшего объекта (нормированное: 0 = вплотную, 1 = ничего)
- тип объекта: еда / свой / чужой / неизвестно (зависит от hasIFF)

```typescript
interface RayVisionGene {
  type: "rayVision";
  rayCount: number;       // 1..16, количество лучей
  fov: number;            // 0.1..2π, угол обзора (рад)
  maxDistance: number;     // 10..200, дальность зрения
  offsetAngle: number;    // -π..π, поворот центра FOV относительно направления существа
}
```

**Входы в нейросеть (на каждый луч):**
- `distance`: float [0, 1] — расстояние (1 = ничего видно)
- `type_food`: float {0, 1} — попал ли луч в еду
- `type_creature`: float {0, 1} — попал ли луч в существо
- `type_iff`: float {-1, 0, 1} — свой (+1), чужой (-1), неизвестно (0, если нет IFF)

Итого входов: `rayCount * 4`

**Стоимость:** `visionCostPerRay * rayCount` энергии за тик

**Мутации:**
- `rayCount`: ±1 с вероятностью `mutationRate / 2`, clamp [1, 16]
- `fov`: jitter, clamp [0.1, 2π]
- `maxDistance`: jitter, clamp [10, 200]
- `offsetAngle`: jitter, wrap [-π, π]

### 3.2 Touch (`touch`)

Сенсор контакта: срабатывает при физическом столкновении с другим объектом.

```typescript
interface TouchGene {
  type: "touch";
  // Нет параметров — это простейший сенсор
}
```

**Входы в нейросеть:**
- `touching_food`: float {0, 1} — касается ли еды
- `touching_creature`: float {0, 1} — касается ли другого существа
- `touching_iff`: float {-1, 0, 1} — свой/чужой/неизвестно

Итого входов: 3

**Стоимость:** 0 (бесплатный)

### 3.3 Energy Sense (`energySense`)

Внутренний сенсор: собственный уровень энергии.

```typescript
interface EnergySenseGene {
  type: "energySense";
}
```

**Входы в нейросеть:**
- `energy_level`: float [0, 1] — текущая энергия / maxEnergy

Итого входов: 1

**Стоимость:** 0

### 3.4 Broadcast Receiver (`broadcastReceiver`)

Приём broadcast-сигналов от других существ.

```typescript
interface BroadcastReceiverGene {
  type: "broadcastReceiver";
  channels: number[];  // Список каналов для прослушивания, подмножество [0..signalChannels-1]
}
```

**Входы в нейросеть (на каждый канал):**
- `signal_strength`: float [0, 1] — есть ли сигнал (1 = максимум, убывает с расстоянием)
- `signal_direction`: float [-1, 1] — направление на источник (относительно heading существа, нормировано)

Итого входов: `channels.length * 2`

**Стоимость:** 0

**Мутации:**
- Добавить/убрать канал с вероятностью `mutationRate / 2`

---

## 4. Актуаторы (`ActuatorGene`)

Каждый актуатор — выход нейросети, преобразующийся в действие.

### 4.1 Movement (`move`)

```typescript
interface MoveActuatorGene {
  type: "move";
  // Всегда присутствует (нельзя удалить мутацией)
}
```

**Выходы нейросети:**
- `forward`: float [-1, 1] — скорость: -1 = назад (maxSpeed * 0.5), +1 = вперёд (maxSpeed)
- `turn`: float [-1, 1] — поворот: -1 = влево (maxTurnRate), +1 = вправо (maxTurnRate)

Итого выходов: 2

### 4.2 Attack (`attack`)

```typescript
interface AttackActuatorGene {
  type: "attack";
}
```

**Выходы нейросети:**
- `attack`: float — если > 0.5, существо атакует

Итого выходов: 1

**Мутации:** может быть удалён (существо теряет возможность атаковать) или добавлен.

### 4.3 Eat (`eat`)

```typescript
interface EatActuatorGene {
  type: "eat";
}
```

**Выходы нейросети:**
- `eat`: float — если > 0.5 и существо касается еды, еда поглощается

Итого выходов: 1

**Мутации:** может быть удалён (существо не может есть!) или добавлен.
Удаление `eat` — летальная мутация в долгосрочной перспективе, но эволюция это покажет.

### 4.4 Donate (`donate`)

```typescript
interface DonateActuatorGene {
  type: "donate";
}
```

**Выходы нейросети:**
- `donate`: float — если > 0.5, существо донатит ближайшему "своему"

Итого выходов: 1

**Требования:** работает только если `hasIFF = true`.

### 4.5 Broadcast (`broadcast`)

```typescript
interface BroadcastActuatorGene {
  type: "broadcast";
  channel: number;  // Канал для вещания (0..signalChannels-1)
}
```

**Выходы нейросети:**
- `broadcast`: float — если > 0.5, существо вещает на своём канале

Итого выходов: 1

**Мутации:**
- `channel`: может измениться на другой канал
- Может быть добавлен/удалён

---

## 5. Дополнительные входы нейросети (всегда доступны)

Помимо сенсоров, нейросеть всегда получает:

| Вход          | Значение                        | Описание                        |
|---------------|----------------------------------|---------------------------------|
| `bias`        | 1.0                              | Константа (для bias-нейронов)   |
| `random`      | uniform(0, 1) каждый тик         | Стохастичность поведения        |

Итого: 2 постоянных входа

---

## 6. Подсчёт входов/выходов нейросети

```
total_inputs  = 2 (bias + random)
              + sum(sensor.inputCount for each sensor)
              
total_outputs = sum(actuator.outputCount for each actuator)
```

Пример минимального существа:
- Сенсоры: touch (3 входа), energySense (1 вход)
- Актуаторы: move (2 выхода), eat (1 выход)
- Итого: 2 + 3 + 1 = 6 входов, 2 + 1 = 3 выхода

Пример максимального существа:
- Сенсоры: rayVision(16 лучей, 64 входа), touch (3), energySense (1), broadcastReceiver(4 канала, 8)
- Актуаторы: move (2), attack (1), eat (1), donate (1), broadcast (1)
- Итого: 2 + 64 + 3 + 1 + 8 = 78 входов, 2 + 1 + 1 + 1 + 1 = 6 выходов

---

## 7. Мутации ДНК при размножении

При делении каждый ген потомка проходит через мутацию:

1. **Числовые параметры** (radius, fov, maxDistance, etc.):
   - С вероятностью `mutationRate`: `value += gaussian(0, mutationStrength * range)`
   - Результат clamped в допустимый диапазон

2. **Булевы параметры** (hasIFF):
   - С вероятностью `mutationRate / 5`: флип (true ↔ false)

3. **Структурные мутации** (добавление/удаление модулей):
   - С вероятностью `mutationRate / 3`: добавить случайный сенсор (с дефолтными параметрами)
   - С вероятностью `mutationRate / 3`: удалить случайный сенсор (кроме energySense)
   - С вероятностью `mutationRate / 4`: добавить актуатор
   - С вероятностью `mutationRate / 4`: удалить актуатор (кроме move)
   - При добавлении/удалении модуля: соответствующие входы/выходы нейросети обновляются
     (см. документ "Формат мозга")

4. **groupId**: НЕ мутирует. Группа наследуется от родителя.

---

## 8. Начальная ДНК (при создании мира)

При старте мира генерируется `initialCreatures` существ с минимальной ДНК:

```json
{
  "groupId": 0,
  "hasIFF": false,
  "body": { "radius": 5 },
  "sensors": [
    { "type": "rayVision", "rayCount": 3, "fov": 1.5, "maxDistance": 50, "offsetAngle": 0 },
    { "type": "touch" },
    { "type": "energySense" }
  ],
  "actuators": [
    { "type": "move" },
    { "type": "eat" }
  ]
}
```

- `groupId` распределяется циклически (0, 1, 2, ..., numGroups-1, 0, 1, ...).
- Начальные группы определяются параметром: по умолчанию 4 группы.
- Начальный мозг: минимальная NEAT-сеть (прямые связи input→output, случайные веса).

---

## 9. Сериализация

ДНК сериализуется в JSON для:
- Сохранения мира (IndexedDB)
- Экспорта лучших генотипов (`best_genotypes.json`)
- Инспектора в UI

Формат сериализации совпадает с описанными интерфейсами.
